<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Tesla Super Charger Network</title>

<style>

.graticule {
  fill: none;
  stroke: #777;
  stroke-width: .5px;
  stroke-opacity: .5;
}

.land {
  fill: steelblue
}

.boundary {
  fill: none;
  stroke: #fff;
  stroke-width: .5px;
}

</style>
<body>
      <form name="nodeForm" onSubmit="return handleClick()">
        <input type="text" id="node" placeholder="1">
      </form>
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script>
//initial page load call
function draw(world,network_data,div_name){
    //page update function called after any changes
  var width = 1300,
      height = 600;

  var projection = d3.geo.mercator()
      .center([70, 48])
      .scale(650)
      .rotate([-180,0]);

  var path = d3.geo.path()
      .projection(projection);

  var graticule = d3.geo.graticule();

  var svg = d3.select(div_name).append("svg")
      .attr("width", width)
      .attr("height", height);

  svg.append("path")
      .datum(graticule)
      .attr("class", "graticule")
      .attr("d", path);

    function handleClick(event){
        console.log(document.getElementById("node").value)
        update(document.getElementById("node").value)
        return false;
    }

    function update(node){
      node = +node // convert string input to int for equality evaluations

      d3.selectAll('.connection').remove();
      d3.selectAll('.node').remove();

      var connection = svg.selectAll(".connection")
      .data(network_data['links'])
       .enter().append("g")
      .filter(function(d) { return !d.SC_index <= node; })
      .attr("class","connection")
      .append("line")
      .style("stroke","black")
      .attr("x1", function(d){return projection(d['lon_lat_1'])[0]})
      .attr("y1", function(d){return projection(d['lon_lat_1'])[1]})
      .attr("x2", function(d){return projection(d['lon_lat_2'])[0]})
      .attr("y2", function(d){return projection(d['lon_lat_2'])[1]})

      var node = svg.selectAll(".node")
      .data(network_data['nodes'])
      .enter().append("g")
      .filter(function(d) { return !d.latest_node <= node; })
      .attr("class","node")
      .append("circle")
      .attr("cx", function (d) {return projection(d['GPS_lon_lat'])[0]; })
      .attr("cy", function (d) {return projection(d['GPS_lon_lat'])[1]; })
      .attr("r", "2px")
      .attr("fill", "red")   
    }

  //build discipline selection pane
  function draw_world(error, world) {
    if (error) throw error;

    svg.insert("path", ".graticule")
        .datum(topojson.feature(world, world.objects.land))
        .attr("class", "land")
        .attr("d", path);

    svg.insert("path", ".graticule")
        .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
        .attr("class", "boundary")
        .attr("d", path);
    }

    d3.json("world.json", draw_world)
    //initial draw call on page load
    update("1")

  };
d3.json("network.json", draw)
</script>